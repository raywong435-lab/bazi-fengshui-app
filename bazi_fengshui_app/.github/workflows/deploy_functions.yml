name: Deploy Firebase Functions

on:
  push:
    branches:
      - main
    paths:
      - 'firebase/functions/**' # 根據我們的目錄結構調整路徑

jobs:
  deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./firebase/functions # 將工作目錄設定為 functions 資料夾

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' # 根據您的 Firebase Functions 執行環境指定版本

      - name: Install Dependencies
        run: npm ci # 使用 ci 可確保依賴版本的一致性

      - name: Run Tests
        run: npm test # 假設您在 package.json 中設定了測試腳本

      - name: Deploy to Firebase Functions
        uses: w9jds/firebase-action@master
        with:
          args: deploy --only functions
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
          PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
